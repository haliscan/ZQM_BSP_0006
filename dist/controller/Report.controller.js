sap.ui.define(["../controller/App.controller","../model/formatter","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ushell/Container"],(e,t,n,i,r)=>{"use strict";var o={};return e.extend("com.karsan.qm.taskmanage.controller.Report",{formatter:t,onInit:function(){o=this.getOwnerComponent().getModel();o.setSizeLimit(1e6);this.getRouter().getRoute("Report").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(){this.getOwnerComponent().getModel().metadataLoaded().then(async()=>{await this._getUserInformation();let e=r.getUser().getId().toUpperCase();const t=o.createKey("/UserSet",{Uname:e});const n=await this.onRead(t,o);this.getViewModel().setProperty("/LoggedUser",n);await this.onInitFilter();this._setSFBconfig()})},onInitFilter:async function(){let e=this.getViewModel().getProperty("/LoggedUser");let t=this.byId("idSfbReportSet").getControlByKey("Lifnum");if(e.IsSupplier){t.removeAllTokens();t.setValue(e.Uname);t.setEnabled(false)}},_getUserInformation:async function(){return new Promise((e,t)=>{if(window.top===window){e();return}i.show();this._readBtpWorkzoneId().then(n=>{const r=n.BtpWorkzoneID||n.BtpLinkID||n.BtpLink||"";let o;const s=async n=>{if(n.origin!==r)return;try{const t=JSON.parse(n.data);if(t?.RequestID==="UserMailRequest"&&t.UserMail){clearInterval(o);window.removeEventListener("message",s);await this._verifySupplierEmail(t.UserMail);i.hide();e()}}catch(e){clearInterval(o);window.removeEventListener("message",s);this._rejectInvalidUserAccess(s,o);t(e)}};window.addEventListener("message",s);o=setInterval(()=>{window.top.postMessage(JSON.stringify({RequestID:"UserMailRequest"}),r)},3e3)}).catch(e=>{i.hide();this._rejectInvalidUserAccess();t(e)})})},_readBtpWorkzoneId:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((e,n)=>{t.read(`/BtpLinkSet('OWN')`,{success:e,error:n})})},_verifySupplierEmail:async function(e){try{const t=await this._readUserByEmail(e);this.getView().getModel().setHeaders({email:e});return t}catch(e){this._rejectInvalidUserAccess();throw e}},_readUserByEmail:function(e){const t=this.getOwnerComponent().getModel("btpService");return new Promise((n,i)=>{t.read(`/SupplierLogonInfoSet('${e}')`,{success:n,error:i})})},_rejectInvalidUserAccess:function(e,t){i.hide();if(t)clearInterval(t);if(e)window.removeEventListener("message",e);let r=this.getView().getModel("i18n").getProperty("AuthSupplierNotFound");n.error(r,{actions:[n.Action.CLOSE],onClose:()=>{history.go(-1)}})},getViewModel:function(){return this.getView().getModel("viewModel")},onRead(e,t){return new Promise((n,i)=>{const r={success:n,error:i};t.read(e,r)})},onSelectNotif:function(e){var t=e.getParameter("rowBindingContext").getObject();this.getViewModel().setProperty("/NavParams",{View:"Notif",Qmnum:t.Qmnum,Manum:t.Manum,Action:"Display"});this.getRouter().navTo("Task",{Qmnum:t.Qmnum,Manum:t.Manum})},_setSFBconfig:function(){var e=this.byId("idSfbReportSet");if(e){e.attachInitialise(function(){var t=["Qmart"];t.forEach(function(t){var n=e.getControlByKey(t);if(n&&typeof n.setEnabled==="function"){n.setEnabled(false)}if(n&&typeof n.setEditable==="function"){n.setEditable(false)}})})}},_toggleVisibleSupplierFilter:function(){var e=this.byId("idSfbReportSet");if(e){var t=e.getControlByKey("Lifnum");if(t){t.setVisible(!t.getVisible())}}}})});
//# sourceMappingURL=Report.controller.js.map