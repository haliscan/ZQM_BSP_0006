sap.ui.define(["../controller/App.controller","sap/m/MessageBox","../model/formatter","sap/ui/core/BusyIndicator","sap/m/ColumnListItem","sap/m/Label","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/table/Column","sap/m/Column","sap/m/Text","sap/ui/core/library","sap/m/MessageItem","sap/m/MessageView","sap/m/Input","sap/m/Button","sap/m/Dialog","sap/m/Bar","sap/m/Title","sap/ui/core/IconPool","sap/ui/core/Core","sap/m/library","sap/m/MessageToast","sap/m/TextArea","sap/ushell/Container","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/comp/filterbar/FilterBar","sap/ui/comp/filterbar/FilterGroupItem","sap/ui/core/message/ControlMessageProcessor","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/Messaging","sap/m/MessagePopover"],(e,t,s,a,i,r,o,n,l,u,p,g,m,c,h,d,f,M,v,T,y,A,_,w,P,R,V,k,C,S,N,x,B,b,H)=>{"use strict";var I=g.TitleLevel,q=A.ButtonType,D=A.DialogType,E=g.ValueState,F={};return e.extend("com.karsan.qm.taskmanage.controller.Task",{formatter:s,onInit:function(){this.getRouter().getRoute("Task").attachMatched(this._onRouteMatched,this)},_onRouteMatched(e){F=this.getOwnerComponent().getModel();F.setSizeLimit(1e6);this.getViewModel().setProperty("/VisDetail",false);let t=e.getParameter("arguments");this._loadNotif(t?.Qmnum,t?.Manum)},_loadNotif:function(e,t){if(!e&&!t){return this.getRouter().navTo("Report")}a.show();let s=`/HeaderSet(Qmnum='${e}',Manum='${t}')`;F.read(s,{urlParameters:{$expand:"Approvement,Notif,Auth"},success:async e=>{let t=await this._checkTaskAuth(e.Qmnum);if(t){this.getViewModel().setProperty("/VisDetail",true);let t=this.getViewModel();t.setProperty("/Header",e);t.setProperty("/Approvement",e.Approvement);t.setProperty("/Notif",e.Notif);t.setProperty("/Auth",e.Auth)}a.hide()},error:e=>{let t=[];let s=this.getView().getModel().getMessagesByPath("");let i=this.getView().getModel().getMessagesByEntity("/HeaderSet");t=[...s,...i];a.hide();this._showMessage(this._formatMessage(t,"FrontSide"))}})},async _checkTaskAuth(e){if(e==="INVALID"||e.includes("UNAUTH")){a.hide();t.error(this.getText(e+"TASK"),{actions:[t.Action.CLOSE],onClose:function(){this.onNavBack()}.bind(this)})}else{return true}},onSave:function(){let e=this;if(e._validateTask()!=="OK"){return}this.confirmAction(this.getText("ConfirmSaveTask"),this.getView()).then(function(t){if(t){let t=e._buildReqHeader();t.Util="Save";e._sendReq(t)}else{_.show(e.getText("MsgCancelled"))}})},onApprove:function(){let e=this;if(e._validateTask()!=="OK"){return}this.confirmAction(this.getText("ConfirmApproveTask"),this.getView()).then(function(t){if(t){let t=e._buildReqHeader();t.Util="Approve";e._sendReq(t)}else{_.show(e.getText("MsgCancelled"))}})},onReject:function(){let e=this;if(e._validateTask()!=="OK"){return}this.confirmAction(this.getText("ConfirmRejectTask"),this.getView()).then(function(t){if(t){let t=e._buildReqHeader();t.Util="Reject";e._sendReq(t)}else{_.show(e.getText("MsgCancelled"))}})},_sendReq(e){let t=this;a.show();F.create("/HeaderSet",e,{success:e=>{a.hide();const s=e.Return.results.some(e=>["E","A","X"].includes(e.Type));if(!s){t._loadNotif(e.Qmnum,e.Manum)}let i={seqnr:1,function:"this.onNavBack",event:{}};t.getViewModel().setProperty("/WaitingAction",[i]);t._showMessage(e.Return.results)},error:e=>{let s=[];let i=t.getView().getModel().getMessagesByPath("");let r=t.getView().getModel().getMessagesByEntity("/HeaderSet");s=[...i,...r];a.hide();t._showMessage(s)}})},_buildReqHeader:function(){let e=this.getViewModel();let t=e.getProperty("/Header");let s={Util:"",Qmnum:t.Qmnum,Manum:t.Manum,Approvement:e.getProperty("/Approvement"),Notif:e.getProperty("/Notif"),Auth:e.getProperty("/Auth"),Return:[]};delete s.Approvement.__metadata;delete s.Auth.__metadata;delete s.Notif.__metadata;return s},_validateTask:function(){let e=this.getViewModel(),t=e.getProperty("/Approvement");const s=e=>e===undefined||e===null||e.trim()==="";if(s(t.Descr)){let e={type:"Error",message:this.getText("ErrEmptyDescr"),subtitle:this.getText("ApprovementTab"),groupName:"",activeTitle:true,controlId:"IdApprovementDescr"};this._addMessage(e);return this._showMessage()}return"OK"},onChangeInput(e){var t="",s="",a=this._removeSpaces(e.getParameter("value"));if(e.getSource().getBinding("value").getContext()){t=e.getSource().getBinding("value").getContext().sPath+"/"}var i=e.getSource().getBinding("value").sPath;if(!t){s=t+i}this.getViewModel().setProperty(s,a);if(a!==""){e.getSource().setValueState("None")}},onNavBack:function(){let e=this.getViewModel();e.setProperty("/Header",{});e.setProperty("/Approvement",{});e.setProperty("/Notif",{});e.setProperty("/Auth",{});this.getRouter().navTo("Report")}})});
//# sourceMappingURL=Task.controller.js.map